<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SAM.gov RFI Agent</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  body {font-family:'Inter',sans-serif;background:#fafafa;color:#222;margin:2rem;max-width:900px;}
  h1 {font-size:1.5rem;margin-bottom:.5rem;}
  select {font-size:1rem;padding:.4rem .6rem;margin-bottom:1rem;}
  .card {background:#fff;border:1px solid #ddd;border-radius:8px;
         padding:1rem;margin-bottom:1rem;box-shadow:0 2px 4px rgba(0,0,0,.05);}
  .score {font-weight:700;font-size:1.5rem;text-align:right;}
  a {text-decoration:none;color:#0066cc;font-weight:500;}
  a:hover {text-decoration:underline;}
  .error {color:#c33;background:#fee;padding:1rem;border-radius:4px;margin:1rem 0;}
  .meta {font-size:0.85rem;color:#666;margin-top:0.5rem;}
</style>
</head>
<body>
<h1>SAM.gov RFI Agent</h1>
<label>
  Company type:
  <select id="industry">
    <option value="it" selected>IT / Federal-Tech</option>
    <option value="logistics">Logistics</option>
    <option value="staffing">Staffing / Services</option>
  </select>
</label>
<div id="feed">Loading…</div>

<script type="module">
// ==== CONFIG ====
const GEMINI_API_KEY = "YOUR_GEMINI_KEY_HERE";
const LAMBDA_ENDPOINT = "https://jcsmad2nf7gbhxyarmpykpmdwm0bafge.lambda-url.us-east-1.on.aws/contracts";

// ==== PROMPT TEMPLATES ====
const prompts = {
  it: {
    desc: "Summarize for a federal IT contractor (cloud, cybersecurity, data).",
    draft: "Score fit for an IT company (FedRAMP, cloud, analytics). Score from 0-100."
  },
  logistics: {
    desc: "Summarize for a logistics / transportation firm (warehousing, freight).",
    draft: "Score fit for a logistics company. Score from 0-100."
  },
  staffing: {
    desc: "Summarize for a staffing / professional-services vendor (labor categories, cleared staff).",
    draft: "Score fit for a staffing company. Score from 0-100."
  }
};

// ==== DATA FETCH ====
async function fetchRFIs() {
  try {
    const res = await fetch(LAMBDA_ENDPOINT);
    if (!res.ok) throw new Error(`Lambda error: ${res.status}`);
    const data = await res.json();
    
    console.log("Lambda response:", data);
    
    if (!data.success) {
      throw new Error(data.error || 'Failed to fetch opportunities');
    }
    
    return data.opportunities || [];
  } catch(e) {
    console.error("Fetch error:", e);
    throw e;
  }
}

// ==== GEMINI CALL ====
async function analyze(rfi, industry) {
  if(GEMINI_API_KEY === "YOUR_GEMINI_KEY_HERE") {
    return {summary:"⚠️ Add your Gemini API key", score:0};
  }
  
  const p = prompts[industry];
  const prompt = `${p.desc}

Return ONLY valid JSON with no markdown:
{"summary":"brief summary", "score":85}

${p.draft}

Title: ${rfi.title}
Agency: ${rfi.agency}
Set-Aside: ${rfi.setAside}
NAICS: ${rfi.naics}
Description: ${rfi.description}`;

  try {
    const r = await fetch(
      "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + GEMINI_API_KEY,
      {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({contents: [{parts: [{text: prompt}]}]})
      }
    );
    
    if(!r.ok) throw new Error(`Gemini error: ${r.status}`);
    
    const j = await r.json();
    let text = j.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
    text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    
    const parsed = JSON.parse(text);
    return {
      summary: parsed.summary || "No summary",
      score: Math.min(100, Math.max(0, parseInt(parsed.score) || 0))
    };
  } catch(e) {
    console.error("Analysis error:", e);
    return {summary: `Error: ${e.message}`, score: 0};
  }
}

// ==== RENDER ====
function render(list) {
  const feed = document.getElementById("feed"); 
  feed.innerHTML = "";
  
  if(list.length === 0) {
    feed.innerHTML = "<div class='error'>No RFIs found</div>";
    return;
  }
  
  list.forEach(r => {
    const c = document.createElement("div");
    c.className = "card";
    const color = r.score >= 80 ? "#d2f8d2" : r.score >= 60 ? "#fff6b3" : "#f8d2d2";
    c.style.background = color;
    c.innerHTML = `
      <div><b>${r.title}</b><br><small>${r.agency} • ${r.setAside} • ${r.naics}</small></div>
      <p>${r.summary}</p>
      <div class="score">${r.score}</div>
      <div class="meta">Posted: ${r.postedDate ? new Date(r.postedDate).toLocaleDateString() : 'N/A'}</div>
      <a href="${r.url}" target="_blank">View on SAM.gov →</a>`;
    feed.appendChild(c);
  });
}

// ==== MAIN ====
async function run() {
  try {
    const industry = document.getElementById("industry").value;
    document.getElementById("feed").innerHTML = "Fetching RFIs from SAM.gov…";
    const rfis = await fetchRFIs(); 
    
    if(rfis.length === 0) {
      document.getElementById("feed").innerHTML = "<div class='error'>No opportunities found</div>";
      return;
    }
    
    const results = [];
    document.getElementById("feed").innerHTML = `Analyzing ${rfis.length} RFIs with AI…`;
    
    for(const r of rfis) {
      const a = await analyze(r, industry);
      results.push({...r, ...a});
      render(results);
    }
  } catch(e) {
    document.getElementById("feed").innerHTML = `<div class="error"><b>Error:</b> ${e.message}</div>`;
  }
}

document.getElementById("industry").addEventListener("change", run);
run();
</script>
</body>
</html>